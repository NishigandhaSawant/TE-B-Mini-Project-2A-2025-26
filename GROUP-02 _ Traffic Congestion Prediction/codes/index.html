<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Traffic Prediction — Comparative UI</title>

	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

	<style>
		:root{
			--bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#7c3aed;
			--glass: rgba(255,255,255,0.03);
			--round: 12px;
		}
		*{box-sizing:border-box}
		body{
			margin:0;
			font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
			background: linear-gradient(180deg, #071025 0%, #071428 60%);
			color:#e6eef8;
			-webkit-font-smoothing:antialiased;
			-moz-osx-font-smoothing:grayscale;
			padding:28px;
		}

		header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px;}
		header h1{margin:0;font-size:20px;letter-spacing:0.2px}
		header p{margin:0;color:var(--muted);font-size:13px}

		.layout{display:grid;grid-template-columns: 360px 1fr;gap:18px;align-items:start;}

		.panel{
			background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
			border-radius:var(--round);
			padding:16px;
			box-shadow: 0 6px 18px rgba(2,6,23,0.6);
			border:1px solid rgba(255,255,255,0.03);
		}
		label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
		.field{margin-bottom:12px}
		input[type="text"], select, input[type="number"]{
			width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);
			background:var(--glass);color:inherit;outline:none;font-size:14px;
		}
		.two{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
		.checkbox{display:flex;align-items:center;gap:8px;margin-top:6px;}
		.btn{
			background: linear-gradient(90deg,#7c3aed,#06b6d4);
			border:none;color:white;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;
			box-shadow:0 6px 18px rgba(0,0,0,0.45);
		}
		.btn-small{
			background:var(--glass);
			border:1px solid rgba(255,255,255,0.1);
			color:white;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:500;
			font-size:13px;
			transition:background 0.2s;
		}
		.btn-small:hover{background:rgba(255,255,255,0.1);}
		.muted{color:var(--muted);font-size:13px}
		.small{font-size:12px;color:var(--muted)}

		.charts{display:grid;grid-template-rows: auto auto 1fr;gap:14px;}
		.chart-card{
			background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
			border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03);
			display:flex;flex-direction:column;
		}
		.chart-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
		.legend{display:flex;gap:10px;align-items:center}
		.legend .item{display:flex;gap:8px;align-items:center;font-size:13px;color:var(--muted)}
		.swatch{width:14px;height:8px;border-radius:3px}
		.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;}

		table{width:100%;border-collapse:collapse;font-size:13px;}
		td,th{padding:8px 10px;border-bottom:1px dashed rgba(255,255,255,0.03)}
		th{text-align:left;color:var(--muted);font-size:12px}

		footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
		@media (max-width:900px){.layout{grid-template-columns:1fr;}}

		/* --- MODAL CSS for Popup --- */
		.modal {
			display: none; /* Hidden by default */
			position: fixed; /* Stay in place */
			z-index: 100; /* Sit on top */
			left: 0;
			top: 0;
			width: 100%; /* Full width */
			height: 100%; /* Full height */
			overflow: auto; /* Enable scroll if needed */
			background-color: rgba(0, 0, 0, 0.8); /* Black w/ opacity */
			padding-top: 60px;
		}

		.modal-content {
			background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
			border-radius:var(--round);
			padding:24px;
			box-shadow: 0 8px 30px rgba(0,0,0,0.8);
			border:1px solid rgba(255,255,255,0.05);
			margin: 5% auto; /* 5% from the top and centered */
			width: 80%; /* Could be more or less, depending on screen size */
			max-width: 800px;
			position: relative;
		}

		.modal-content h2 {
			color: var(--accent);
			margin-top: 0;
			border-bottom: 1px solid rgba(255,255,255,0.1);
			padding-bottom: 10px;
		}

		.modal-content p {
			font-size: 14px;
			line-height: 1.6;
		}

		.modal-content strong {
			color: #ffffff;
		}

		.close-btn {
			color: var(--muted);
			float: right;
			font-size: 28px;
			font-weight: bold;
			position: absolute;
			top: 10px;
			right: 20px;
			cursor: pointer;
			transition: color 0.2s;
		}

		.close-btn:hover,
		.close-btn:focus {
			color: #fff;
			text-decoration: none;
			cursor: pointer;
		}
		/* --- END MODAL CSS --- */

	</style>
</head>
<body>

	<header>
		<div>
			<h1>Traffic Prediction — Comparative Visualizer</h1>
			<p class="small">Run a 24-hour comparative analysis. LSTM/Prophet are proxies unless implemented.</p>
		</div>
		<div class="small muted">Multiple algorithms · Comparative chart</div>
	</header>

	<main class="layout">
		<aside class="panel">
			<h2 style="font-size:15px">Inputs</h2>
			<div class="field"><label for="place">Place</label><input id="place" type="text" value="Mumbai - Bandra"></div>
			<div class="two">
				<div class="field"><label for="dataset">Dataset</label>
					<select id="dataset"><option value="1_month">1 month</option><option value="3_months">3 months</option><option value="6_months">6 months</option><option value="1_year">1 year</option></select>
				</div>
				<div class="field"><label for="day">Day</label>
					<select id="day"><option value="0">Sunday</option><option value="1">Monday</option><option value="2">Tuesday</option><option value="3">Wednesday</option><option value="4">Thursday</option><option value="5">Friday</option><option value="6">Saturday</option></select>
				</div>
			</div>
			<div class="two">
				<div class="field"><label for="hour">Base hour</label><input id="hour" type="number" min="0" max="23" value="9"></div>
				<div class="field"><label for="sim">Run mode</label>
					<select id="sim"><option value="hour">Single hour + 24h</option><option value="full">Full 24h</option></select>
				</div>
			</div>
			<div class="field">
				<div class="checkbox"><input id="raining" type="checkbox"><label for="raining" class="small">Raining</label></div>
				<div class="checkbox"><input id="peak" type="checkbox"><label for="peak" class="small">Peak hour</label></div>
			</div>
			<div style="display:flex;gap:10px;margin-top:10px">
				<button class="btn" id="runBtn">Run Analysis</button>
				<button class="btn" id="exportBtn" style="background:linear-gradient(90deg,#111827,#0ea5a4)">Export PNG</button>
			</div>
		</aside>

		<section class="charts">
			<div class="grid">
				<div class="chart-card"><div class="chart-head"><strong>Time-Series</strong></div><canvas id="tsChart"></canvas></div>
				<div class="chart-card"><div class="chart-head"><strong>Linear</strong></div><canvas id="linearChart"></canvas></div>
				<div class="chart-card"><div class="chart-head"><strong>LSTM (sim)</strong></div><canvas id="lstmChart"></canvas></div>
				<div class="chart-card"><div class="chart-head"><strong>Prophet (sim)</strong></div><canvas id="prophetChart"></canvas></div>
			</div>
			<div class="chart-card"><div class="chart-head"><strong>Comparative — All</strong></div><canvas id="combinedChart" height="160"></canvas></div>
			<div class="chart-card">
				<div class="chart-head"><strong>Metrics</strong></div>
				<table><thead><tr><th>Model</th><th>Pred</th><th>Err%</th></tr></thead>
					<tbody>
						<tr><td>Linear</td><td id="m_linear">—</td><td id="e_linear">—</td></tr>
						<tr><td>TimeSeries</td><td id="m_ts">—</td><td id="e_ts">—</td></tr>
						<tr><td>LSTM (sim)</td><td id="m_lstm">—</td><td id="e_lstm">—</td></tr>
						<tr><td>Prophet (sim)</td><td id="m_prophet">—</td><td id="e_prophet">—</td></tr>
					</tbody></table>
				<div class="small muted">Raw hist sample: <span id="rawSample">—</span></div>
			</div>
		</section>
	</main>

<section style="margin-top:40px">
	<h2 style="font-size:18px;margin-bottom:16px">Formulas, Concepts & Examples</h2>
	<div style="display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))">

		<div class="chart-card" style="display:flex;gap:12px;align-items:center;flex-direction:column;align-items:flex-start;">
			<div style="display:flex;gap:12px;align-items:center;">
				<div style="flex-shrink:0">
					<img src="https://img.icons8.com/ios-filled/48/ffffff/line-chart.png" style="width:48px;height:48px;animation:popIn 1s;" />
				</div>
				<div>
					<h3>Linear Regression</h3>
					<p><b>Formula:</b> ŷ = β₀ + β₁·X₁ + β₂·X₂ + …</p>
					<p><b>Example:</b> β₀=5, β₁=2(hour), β₂=3(peak). Hour=9, peak=1 → ŷ=26 mins.</p>
				</div>
			</div>
			<button class="btn-small" data-algo="linear">View Full Explanation</button>
		</div>

		<div class="chart-card" style="display:flex;gap:12px;align-items:center;flex-direction:column;align-items:flex-start;">
			<div style="display:flex;gap:12px;align-items:center;">
				<div style="flex-shrink:0">
					<img src="https://img.icons8.com/ios-filled/48/ffffff/time-machine.png" style="width:48px;height:48px;animation:popIn 1s 0.2s;" />
				</div>
				<div>
					<h3>Time-Series Averaging</h3>
					<p><b>Formula:</b> ŷₜ = (1/k) Σ xₜ₋ᵢ</p>
					<p><b>Example:</b> Last 3 values [24,28,26] → ŷ=26 mins.</p>
				</div>
			</div>
			<button class="btn-small" data-algo="ts">View Full Explanation</button>
		</div>

		<div class="chart-card" style="display:flex;gap:12px;align-items:center;flex-direction:column;align-items:flex-start;">
			<div style="display:flex;gap:12px;align-items:center;">
				<div style="flex-shrink:0">
					<img src="https://img.icons8.com/ios-filled/48/ffffff/artificial-intelligence.png" style="width:48px;height:48px;animation:popIn 1s 0.4s;" />
				</div>
				<div>
					<h3>LSTM</h3>
					<p><b>Formula:</b> cₜ = fₜ·cₜ₋₁ + iₜ·gₜ ; hₜ = oₜ·tanh(cₜ)</p>
					<p><b>Example:</b> cₜ₋₁=20,f=0.8,i=0.5,g=10 → cₜ=21 → pred≈21 mins.</p>
				</div>
			</div>
			<button class="btn-small" data-algo="lstm">View Full Explanation</button>
		</div>

		<div class="chart-card" style="display:flex;gap:12px;align-items:center;flex-direction:column;align-items:flex-start;">
			<div style="display:flex;gap:12px;align-items:center;">
				<div style="flex-shrink:0">
					<img src="https://img.icons8.com/ios-filled/48/ffffff/calendar.png" style="width:48px;height:48px;animation:popIn 1s 0.6s;" />
				</div>
				<div>
					<h3>Prophet</h3>
					<p><b>Formula:</b> y(t) = g(t) + s(t) + h(t) + εₜ</p>
					<p><b>Example:</b> trend=20, s=+3, h=+2 → y=25 mins.</p>
				</div>
			</div>
			<button class="btn-small" data-algo="prophet">View Full Explanation</button>
		</div>
	</div>

	<style>
		@keyframes popIn{
			0%{transform: scale(0.5);opacity:0;}
			100%{transform: scale(1);opacity:1;}
		}
	</style>
</section>

	<section style="margin-top:40px">
		<div class="chart-card">
			<h3>Which Algorithm is Best?</h3>
			<p><b>Usually, Prophet is the best balance of accuracy and interpretability.</b></p>
			<p id="dynamicBest" style="margin-top:6px"><b>Current dataset best: —</b></p>
			<ul class="small muted">
				<li><b>Linear</b>: simple, fast, but too limited.</li>
				<li><b>Time-Series Avg</b>: smooths noise, poor long-term accuracy.</li>
				<li><b>LSTM</b>: powerful with big data, but complex to train.</li>
				<li><b>Prophet</b>: models trend+seasonality+holidays directly → ideal for traffic.</li>
			</ul>
			<p><b>Reason:</b> Traffic has strong daily/weekly seasonality (rush hours, weekends), which Prophet handles naturally.
			LSTM may outperform Prophet with huge datasets but needs more compute and tuning.</p>
		</div>
	</section>

	<footer>Built for your prediction suite — integrates with <code>multi_algo_prediction_model.js</code>.</footer>

	<div id="explanationModal" class="modal">
		<div class="modal-content">
			<span class="close-btn">&times;</span>
			<h2 id="modalTitle"></h2>
			<div id="modalContent"></div>
		</div>
	</div>

	<script src="multi_algo_prediction_model.js"></script>
	<script>
const COLORS={lstm:'#ef4444',prophet:'#3b82f6',linear:'green',timeseries:'orange'};
let charts={};
const modal = document.getElementById('explanationModal');
const closeBtn = document.getElementsByClassName('close-btn')[0];
const modalContentDiv = document.getElementById('modalContent');
const modalTitle = document.getElementById('modalTitle');

// --- ALGORITHM EXPLANATION DETAILS ---
// --- ALGORITHM EXPLANATION DETAILS (SIMPLIFIED) ---
const ALGO_DETAILS = {
	linear: {
		title: 'Linear Regression: Simple Trend Modeling',
		content: `
			<p><strong>Concept:</strong> Linear Regression assumes a linear relationship between input variables (like hour, day, rain, peak) and the output (traffic time). It models this relationship using a straight line or plane.</p>
			<p><strong>Formula:</strong> ŷ = &beta;₀ + &beta;₁·X₁ + &beta;₂·X₂ + ... + &epsilon;</p>
			<p>Where:</p>
			<ul>
				<li>ŷ is the predicted traffic time.</li>
				<li>&beta;₀ is the intercept (baseline traffic time).</li>
				<li>&beta;ᵢ are the coefficients (weights) that determine the impact of each variable Xᵢ.</li>
			</ul>
			<p><strong>Full Example Solved:</strong></p>
			<p>Assume the model is trained with these coefficients: Intercept (&beta;₀) = 5 mins. Coefficient for Hour (&beta;₁) = 2. Coefficient for Peak Hour (&beta;₂) = 3. All other variables have a coefficient of 0.</p>
			<p><strong>Input:</strong> Hour = 9, Peak Hour = 1 (Yes).</p>
			<p><strong>Calculation:</strong></p>
			<p>ŷ = 5 + (2 &times; 9) + (3 &times; 1)</p>
			<p>ŷ = 5 + 18 + 3 = 26 minutes.</p>
			<p><strong>Explanation:</strong> The baseline traffic is 5 minutes. The 9th hour adds 18 minutes, and the peak hour condition adds 3 minutes, totaling a 26-minute predicted travel time.</p>
		`
	},
	ts: {
		title: 'Time-Series Averaging: Moving Average Method',
		content: `
			<p><strong>Concept:</strong> Time-Series Averaging, often a simple <strong>Moving Average</strong>, predicts the next value in a sequence by taking the average of the last 'k' observed values. It's excellent for smoothing out short-term fluctuations but is sensitive to 'k' and struggles with trends/seasonality.</p>
			<p><strong>Formula (Simple Moving Average):</strong> ŷₜ = (1 / k) &Sigma; xₜ₋ᵢ</p>
			<p>Where:</p>
			<ul>
				<li>ŷₜ is the prediction for the current time 't'.</li>
				<li>xₜ₋ᵢ is the actual traffic time 'i' periods ago.</li>
				<li>k is the size of the moving window (the number of past data points to average).</li>
			</ul>
			<p><strong>Full Example Solved:</strong></p>
			<p>Assume a window size k=3 (last 3 data points). The observed traffic times for the last three periods are: xₜ₋₃=24, xₜ₋₂=28, xₜ₋₁=26.</p>
			<p><strong>Calculation:</strong></p>
			<p>ŷₜ = (1 / 3) &times; (24 + 28 + 26)</p>
			<p>ŷₜ = 78 / 3 = 26 minutes.</p>
			<p><strong>Explanation:</strong> The predicted traffic time is the simple arithmetic mean of the last three recorded traffic times, assuming they are the best short-term indicators for the next time step.</p>
		`
	},
	lstm: {
		title: 'LSTM (Long Short-Term Memory): Neural Network for Sequences',
		content: `
			<p><strong>Concept:</strong> LSTM is a specialized type of Recurrent Neural Network (RNN) designed to remember information for long periods, overcoming the <strong>vanishing gradient problem</strong> of standard RNNs. It's ideal for sequential data like traffic time-series.</p>
			<p>The core of an LSTM is the <strong>Cell State (cₜ)</strong>, which is regulated by three main gates:</p>
			<ol>
				<li><strong>Forget Gate (fₜ):</strong> Decides what information to discard from the cell state.</li>
				<li><strong>Input Gate (iₜ) & Candidate (c̃ₜ):</strong> Decides what new information to store in the cell state.</li>
				<li><strong>Output Gate (oₜ):</strong> Decides what the output (hₜ) should be based on the cell state.</li>
			</ol>
			<p><strong>Core Formulas:</strong></p>
			<p><strong>New Cell State:</strong> cₜ = fₜ &middot; cₜ₋₁ + iₜ &middot; gₜ</p>
			<p><strong>Hidden State (Output):</strong> hₜ = oₜ &middot; tanh(cₜ)</p>
			<p><strong>Full Example Solved (Simplified Proxy):</strong></p>
			<p>In a simplified setting, we can see how the cell state is updated:</p>
			<p><strong>Inputs:</strong> Previous Cell State (cₜ₋₁) = 20. Forget Gate (fₜ) = 0.8. Input Gate (iₜ) = 0.5. Candidate State (gₜ) = 10.</p>
			<p><strong>Calculation (Cell State Update):</strong></p>
			<p>cₜ = (0.8 &times; 20) + (0.5 &times; 10)</p>
			<p>cₜ = 16 + 5 = 21</p>
			<p><strong>Result:</strong> The new Cell State is 21. If the Output Gate (oₜ) is 1, the Hidden State (hₜ) and thus the prediction will be close to 21 minutes, demonstrating the 'memory' effect of the previous state (16) combined with new input (5).</p>
		`
	},
	prophet: {
		title: 'Prophet: Decomposable Time Series Model',
		content: `
			<p><strong>Concept:</strong> Prophet (developed by Facebook) is a procedure for forecasting time series data based on an additive model where non-linear trends are fit with yearly, weekly, and daily seasonality, plus holiday effects. It's especially robust for time series with strong seasonal patterns and missing data, making it ideal for traffic prediction.</p>
			<p><strong>Formula (Additive Model):</strong> y(t) = g(t) + s(t) + h(t) + &epsilon;ₜ</p>
			<p>Where:</p>
			<ul>
				<li>y(t) is the predicted value (traffic time) at time 't'.</li>
				<li>g(t) is the <strong>trend</strong> function (non-periodic changes in the series).</li>
				<li>s(t) represents <strong>periodic changes</strong> (seasonality, e.g., weekly rush hours).</li>
				<li>h(t) represents the effects of <strong>holidays or special events</strong>.</li>
				<li>&epsilon;ₜ is the error term.</li>
			</ul>
			<p><strong>Full Example Solved (Simplified Proxy):</strong></p>
			<p>Assume the model determines the following components for a Tuesday morning:</p>
			<p><strong>Components:</strong> Base Trend (g(t)) = 20 minutes. Weekly Seasonality (s(t)) = +3 minutes (Tuesday is a bit heavier than baseline). Holiday Effect (h(t)) = +2 minutes (due to a minor local event).</p>
			<p><strong>Calculation:</strong></p>
			<p>y(t) = 20 + 3 + 2</p>
			<p>y(t) = 25 minutes.</p>
			<p><strong>Explanation:</strong> The prediction is simply the sum of the long-term trend, the weekly pattern, and any relevant external factors, making it highly interpretable.</p>
		`
	}
};
// --- END ALGORITHM EXPLANATION DETAILS (SIMPLIFIED) ---

function createLineChart(ctx,label,color){
	return new Chart(ctx,{
		type:'line',
		data:{labels:Array.from({length:24},(_,i)=>i+':00'),datasets:[{label,data:Array(24).fill(null),tension:0.25,borderColor:color,pointRadius:2}]},
		options:{plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#94a3b8'}},y:{ticks:{color:'#94a3b8'}}}}
	});
}

window.addEventListener('DOMContentLoaded',()=>{
	charts.ts=createLineChart(document.getElementById('tsChart'),'TS',COLORS.timeseries);
	charts.linear=createLineChart(document.getElementById('linearChart'),'Linear',COLORS.linear);
	charts.lstm=createLineChart(document.getElementById('lstmChart'),'LSTM',COLORS.lstm);
	charts.prophet=createLineChart(document.getElementById('prophetChart'),'Prophet',COLORS.prophet);
	charts.combined=new Chart(document.getElementById('combinedChart'),{
		type:'line',
		data:{
			labels:Array.from({length:24},(_,i)=>i+':00'),
			datasets:[
				{label:'LSTM',data:Array(24).fill(null),borderColor:COLORS.lstm},
				{label:'Prophet',data:Array(24).fill(null),borderColor:COLORS.prophet},
				{label:'Linear',data:Array(24).fill(null),borderColor:COLORS.linear},
				{label:'TS',data:Array(24).fill(null),borderColor:COLORS.timeseries}
			]
		},
		options:{plugins:{legend:{labels:{color:'#cbd5e1'}}},scales:{x:{ticks:{color:'#94a3b8'}},y:{ticks:{color:'#94a3b8'}}}}
	});

	document.getElementById('runBtn').addEventListener('click',runAnalysis);
	document.getElementById('exportBtn').addEventListener('click',exportPNG);

	// --- MODAL EVENT LISTENERS ---
	document.querySelectorAll('.btn-small').forEach(button => {
		button.addEventListener('click', function() {
			const algoKey = this.getAttribute('data-algo');
			openExplanationModal(algoKey);
		});
	});

	closeBtn.onclick = function() {
		modal.style.display = 'none';
	}

	window.onclick = function(event) {
		if (event.target == modal) {
			modal.style.display = 'none';
		}
	}

	document.addEventListener('keydown', function(event) {
		if (event.key === 'Escape') {
			modal.style.display = 'none';
		}
	});
	// --- END MODAL EVENT LISTENERS ---
});

// --- NEW FUNCTION TO OPEN MODAL ---
function openExplanationModal(algoKey) {
	const details = ALGO_DETAILS[algoKey];
	if (!details) return;

	modalTitle.textContent = details.title;
	modalContentDiv.innerHTML = details.content;
	modal.style.display = 'block';

	// Optional: Use MathJax/KaTeX to render LaTeX in the content, if available.
	// Since that's not in the original code, we'll assume the user has a setup
	// or will manually add a CDN for rendering (e.g., KaTeX).
	// For now, the LaTeX is just displayed as text.
	// If you had KaTeX, you'd use: katex.render(details.content, modalContentDiv);
}
// --- END NEW FUNCTION TO OPEN MODAL ---


function jitterSeries(base,scale=0.06,bias=0){return base.map(v=>Math.max(0,Math.round((v+(Math.random()*2-1)*scale*v+bias)*10)/10));}

async function runAnalysis(){
	const place=document.getElementById('place').value.trim(),
		datasetKey=document.getElementById('dataset').value,
		day=parseInt(document.getElementById('day').value,10),
		hour=parseInt(document.getElementById('hour').value,10),
		isRaining=document.getElementById('raining').checked,
		isPeak=document.getElementById('peak').checked;
	if(!place){alert('Enter place');return;}
	const btn=document.getElementById('runBtn');btn.disabled=true;btn.textContent='Running...';

	try{
		// Assuming trafficPredictionModel.analyze and predictWithLinearModel are defined in multi_algo_prediction_model.js
		const res=await trafficPredictionModel.analyze(place,datasetKey,day,hour,isRaining,isPeak);
		let tsSeries=(res.hourly_predictions||[]).map(o=>o.predicted_time_minutes);
		while(tsSeries.length<24) tsSeries.push(tsSeries[tsSeries.length-1]||10);

		let linearSeries=[];
		for(let h=0;h<24;h++){
			const pk=(h>=8&&h<11)||(h>=18&&h<21);
			const pred=trafficPredictionModel.predictWithLinearModel({place,datasetKey,day_of_week:day,hour_of_day:h,is_raining:isRaining,is_peak_hour:pk});
			linearSeries.push(pred??tsSeries[h]);
		}

		const lstmSeries=jitterSeries(tsSeries,0.1,-1.2),
			prophetSeries=jitterSeries(tsSeries,0.08,0.6);

		updateChart(charts.ts,tsSeries);updateChart(charts.linear,linearSeries);
		updateChart(charts.lstm,lstmSeries);updateChart(charts.prophet,prophetSeries);

		charts.combined.data.datasets[0].data=lstmSeries;
		charts.combined.data.datasets[1].data=prophetSeries;
		charts.combined.data.datasets[2].data=linearSeries;
		charts.combined.data.datasets[3].data=tsSeries;
		charts.combined.update();

		const hist=res.raw_historical_sample??'N/A';
		document.getElementById('rawSample').textContent=hist;

		function err(pred,sample){if(sample==='N/A'||!sample)return Infinity; return Math.abs(pred-sample)/sample*100;}

		const metrics=[
			{name:'Linear',pred:linearSeries[hour],err:err(linearSeries[hour],hist),id:'linear'},
			{name:'TimeSeries',pred:tsSeries[hour],err:err(tsSeries[hour],hist),id:'ts'},
			{name:'LSTM (sim)',pred:lstmSeries[hour],err:err(lstmSeries[hour],hist),id:'lstm'},
			{name:'Prophet (sim)',pred:prophetSeries[hour],err:err(prophetSeries[hour],hist),id:'prophet'}
		];

		metrics.forEach(m=>{
			document.getElementById('m_'+m.id).textContent=m.pred.toFixed(1);
			document.getElementById('e_'+m.id).textContent=m.err==='Infinity'?'N/A':m.err.toFixed(2)+'%';
		});

		const bestModel=metrics.reduce((a,b)=>a.err<b.err?a:b);
		document.getElementById('dynamicBest').innerHTML=`<b>Current dataset best: ${bestModel.name} (Err ${bestModel.err==='Infinity'?'N/A':bestModel.err.toFixed(2)+'%'})</b>`;

		metrics.forEach(m=>{
			const row=document.getElementById('m_'+m.id).parentElement;
			row.style.background=m.name===bestModel.name?'rgba(124,58,237,0.2)':'transparent';
		});

	}catch(e){console.error(e);alert('Error running analysis');}

	btn.disabled=false;btn.textContent='Run Analysis';
}

function updateChart(chart,series){chart.data.datasets[0].data=series;chart.update();}
function exportPNG(){const url=document.getElementById('combinedChart').toDataURL('image/png');const a=document.createElement('a');a.href=url;a.download='predictions.png';a.click();}
	</script>
</body>
	<footer class="traffic-footer">
		<p>© 2025 TE-DS-B-GRP-2. ALL RIGHTS RESERVED.</p>
		<p>Map data ©2025 Google</p>
		<p>Contact: <a href="tel:1234567890">1234567890</a> |
			Email: <a href="mailto:apsit.teds.grp2@gmail.com">apsit.teds.grp2@gmail.com</a></p><br><br>
	</footer>

</html>