<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Prediction Model Test Page</title>
    <!-- Chart.js for the hourly prediction graph -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #111316;
            color: #e9eef5;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            max-width: 800px;
            width: 100%;
            background-color: #1a1d22;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        h1, h2, h3 {
            color: #3b82f6;
            text-align: center;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #aab3c2;
        }
        .form-group select, .form-group input, .form-group button {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #2a3242;
            background-color: #0f1115;
            color: #e9eef5;
            box-sizing: border-box;
        }
        .form-group button {
            background-color: #3b82f6;
            cursor: pointer;
            font-weight: bold;
            border: none;
            transition: background-color 0.2s;
        }
        .form-group button:hover {
            background-color: #2563eb;
        }
        .output {
            margin-top: 20px;
            padding: 20px;
            background-color: #0f1115;
            border-radius: 8px;
            border: 1px solid #2a3242;
        }
        .output p, .output ul {
            margin: 5px 0;
        }
        .output ul {
            padding-left: 20px;
        }
        hr {
            border-color: #2a3242;
        }
        /* Fix for the chart resizing */
        #predictionChart {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>

    <h1>Prediction Model Test Page</h1>
    <p>This page directly tests the functionality of <code>prediction_model.js</code>.</p>

    <div class="form-group">
        <label for="place">Select Starting Location:</label>
        <select id="place">
            <option value="Thane">Thane</option>
            <option value="Kalyan Junction">Kalyan Junction</option>
            <option value="Dombivli">Dombivli</option>
            <option value="Vashi">Vashi</option>
            <option value="Nerul">Nerul</option>
            <option value="Airoli">Airoli</option>
            <option value="Andheri">Andheri</option>
            <option value="Borivali">Borivali</option>
            <option value="Dadar">Dadar</option>
            <option value="Churchgate">Churchgate</option>
            <option value="Panvel">Panvel</option>
            <option value="Kharghar">Kharghar</option>
            <option value="Ulhasnagar">Ulhasnagar</option>
            <option value="Ambarnath">Ambarnath</option>
            <option value="Badlapur">Badlapur</option>
            <option value="Mira Road">Mira Road</option>
        </select>
    </div>

    <div class="form-group">
        <label for="dataset">Select Dataset for Training:</label>
        <select id="dataset">
            <option value="1_month">1 month</option>
            <option value="3_months">3 months</option>
            <option value="6_months">6 months</option>
            <option value="1_year">1 year</option>
        </select>
    </div>

    <div class="form-group">
        <label for="hour">Select Hour of Day:</label>
        <input type="number" id="hour" min="0" max="23" value="9">
    </div>

    <div class="form-group">
        <label for="day">Select Day of Week:</label>
        <select id="day">
            <option value="0">Monday</option>
            <option value="1">Tuesday</option>
            <option value="2">Wednesday</option>
            <option value="3">Thursday</option>
            <option value="4">Friday</option>
            <option value="5">Saturday</option>
            <option value="6">Sunday</option>
        </select>
    </div>

    <div class="form-group">
        <label for="weather">Is it Raining?</label>
        <select id="weather">
            <option value="false">No</option>
            <option value="true">Yes</option>
        </select>
    </div>

    <div class="form-group">
        <button id="run-prediction">Run Prediction</button>
    </div>

    <div id="output" class="output" style="display:none;">
        <h3>Prediction Output</h3>
        <p><strong>Status:</strong> <span id="status"></span></p>
        <div id="results"></div>
        <hr>
        <h4>24-Hour Prediction Chart</h4>
        <div style="width: 100%; height: 400px; padding: 10px;">
            <canvas id="predictionChart"></canvas>
        </div>
    </div>

<script src="prediction_model.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const placeSelect = document.getElementById('place');
        
        let chart = null;

        function setupChart(labels, data) {
            const ctx = document.getElementById('predictionChart').getContext('2d');
            if (chart) {
                chart.destroy(); // Destroy existing chart to prevent redraw issues
            }
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Predicted Travel Time (minutes)',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Minutes'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Hour of Day'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        document.getElementById('run-prediction').addEventListener('click', async () => {
            const place = placeSelect.value;
            const datasetKey = document.getElementById('dataset').value;
            const hour = parseInt(document.getElementById('hour').value);
            const day = parseInt(document.getElementById('day').value);
            const isRaining = document.getElementById('weather').value === 'true';

            const outputDiv = document.getElementById('output');
            const resultsDiv = document.getElementById('results');
            const statusSpan = document.getElementById('status');

            outputDiv.style.display = 'block';
            statusSpan.textContent = 'Running analysis...';
            resultsDiv.innerHTML = '';

            const result = await trafficPredictionModel.analyze(place, datasetKey, day, hour, isRaining, (hour >= 8 && hour < 11) || (hour >= 18 && hour < 21));

            if (result.error) {
                statusSpan.textContent = `Error: ${result.error}`;
                return;
            }

            statusSpan.textContent = 'Analysis Complete!';
            resultsDiv.innerHTML = `
                <p><strong>Input Parameters:</strong></p>
                <ul>
                    <li><strong>Start Location:</strong> ${place}</li>
                    <li><strong>Dataset:</strong> ${datasetKey}</li>
                    <li><strong>Time:</strong> ${hour}:00, ${getDayName(day)}</li>
                    <li><strong>Weather:</strong> ${isRaining ? 'Raining' : 'Not Raining'}</li>
                </ul>
                <hr>
                <h4>Model Predictions</h4>
                <ul>
                    <li><strong>Linear Regression:</strong> ${result.model_outputs.linear_regression.predicted_time_minutes} min (Error: ${result.model_outputs.linear_regression.error_minutes} min / ${result.model_outputs.linear_regression.accuracy_score})</li>
                    <li><strong>Time-Series Averaging:</strong> ${result.model_outputs.time_series_averaging.predicted_time_minutes} min (Error: ${result.model_outputs.time_series_averaging.error_minutes} min / ${result.model_outputs.time_series_averaging.accuracy_score})</li>
                </ul>
            `;

            // Prepare data for the chart
            const chartLabels = result.hourly_predictions.map(p => `${p.hour}:00`);
            const chartData = result.hourly_predictions.map(p => p.predicted_time_minutes);
            setupChart(chartLabels, chartData);
        });

        function getDayName(dayIndex) {
            const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
            return days[dayIndex];
        }
    });
</script>

</body>
</html>
